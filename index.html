<!DOCTYPE html><html lang="vi-VN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<link id="favicon" rel="icon" type="image/x-icon" href="/assets/dharma-wheel.png">
<title>Thoải mái - Thư giãn - Biết mình</title>
<style>
button, input { height:2em; font-size:0.9em; font-weight:500; padding-bottom:0.3em; padding-top:0.3em; color:rgb(216, 210, 207); background-color:rgb(39, 46, 48); border-color:rgb(105, 91, 86); -webkit-appearance:none; border-radius:0; }
ul, ol { padding-inline-start: 2em; }
li { padding: 0px; padding-bottom: 0.35em; }
body, a, h1 { font-family: Arial, Helvetica, sans-serif; color: rgb(201, 193, 188); background-color: black; }
h1 { font-size: 25px; margin-bottom: 0.2em;  font-weight: 360; color: #E9DA95; } /* color: #E9DA95; */
a, p, li { font-size: 18px; }

#vuotQuaDeDuoi ol > li > i {
	font-weight: bold; font-style: normal; display: block; padding-top: 0.3em; padding-bottom: 0.3em;
	margin-bottom:0.5em; border-bottom: 1px; border-bottom-style: solid;
}
#vuotQuaDeDuoi ol > li {
	border: solid; padding: 1em;
	margin: 0em; margin-top: 2em; padding-bottom: 1.3em;
}
.vqdd {
	margin: 1em;
}
.selectPhapToggle { font-family: 'Courier New', monospace; cursor: pointer; }
blockquote {
  background: #400D00;
  margin: 0em 0px;
  padding: 0.5em 10px;
}
blockquote p { display: inline; }
ul.hilite { background: #400D00; }
ul.hilite > li { padding: 0.5em; padding-left: 0px; margin-left: -15px;  }

@media (min-width: 640px) {
	h1 { font-size: 33px; font-weight: 480; }
	a, p, li { font-size: 20px; }
	#vuotQuaDeDuoi ol { line-height: 40px; }
}
@media (min-width: 960px) {
	h1 { font-size: 40px; font-weight: 540; }
	a, p, li { font-size: 25px; }
	#vuotQuaDeDuoi  ol { line-height: 45px; }
}
@media (min-width: 1280px) {
	h1 { font-size: 50px; font-weight: 560; }
	a, p, li { font-size: 30px; }
	#vuotQuaDeDuoi ol { line-height: 45px; }
}
@media (min-width: 2560px) {
	h1 { font-size: 100px; font-weight: 600; }
	a, p, li { font-size: 50px; }
	#vuotQuaDeDuoi ol { line-height: 60px; }
}

#quote, #quote h1 { background-color: #400D00; }

:fullscreen body { background-color: #400D00; }
:fullscreen #secondHalf { display: none; }
#quote h1 { line-height: 1.5em; }
#quote .hilite { border-bottom-style: dashed; }
#quote .hilite3 { color: #F4F2E5; border-bottom-width: 1.5px; }
#quote .hilite2 { color: #F0EACC; border-bottom-width: 1.5px; }
#quote .hilite1 { color: #EEE4B3; border-bottom-width: 0px; }
</style>
</head>
<body>
<div style="background-color: #400D00; margin:-8px -8px 0 -8px; padding: 8px 8px 0 8px;">
	<div id='playing' style="margin-top:0em; margin-bottom:0.5em;"></div>
	<button id='newQuote' onclick="newQuote()">Lời dạy mới</button>
	<input id="luuAnh" type="button" onclick="luuAnh()" value="Lưu ảnh" />
	<input id="option" type="button" onclick="speakQuoteToggle()" value="Đọc to"/>
	<span style="font-size:12px;"> [ <span id="count">59</span> ]</span>
	<div id="quote" style='margin:0 -8px 0 -8px; padding:0.8em 0.6em 1em 1em; margin-top: 0.5em; margin-bottom:1.5em;'>
		<h1 style='margin:0; margin-bottom: 0.2em;'><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></h1>
		<footer><cite>sutamphap.com</cite></footer>
	</div>
</div>
<div id="secondHalf">
	<button id="nghePhap" onclick="nghePhap()">Nghe pháp</button>
	<button onclick="ngheThuNoi()">Thư nói</button>
	<button onclick="vuotQuaDeDuoi()">Vượt qua dễ duôi</button>
	<div id="thuyetPhapContainer" style="display: none">
	<ul id="thuyetPhap" style="list-style-type:none; padding-left: 0; padding-bottom: 0.5em; margin-bottom:1em;">
		<li><a href="phaps/HuongDanRaQuetVaThuGianToanThan.ogg?https://sutamphap.com/wp-content/uploads/2019/08/HuongDanRaQuetVaThuGianToanThan.mp3">Thư Giãn</a></li>
		<li><a href="phaps/tutaptrongCS_ThienTamTu.ogg?https://sutamphap.com/wp-content/uploads/2019/06/tutaptrongCS_ThienTamTu.mp3">Thiền Tâm Từ</a></li>
		<li><a id="tutaptrongCS_NiemChet" href="phaps/tutaptrongCS_NiemChet.ogg?https://sutamphap.com/wp-content/uploads/2019/06/tutaptrongCS_NiemChet.mp3">Niệm chết</a></li>
	</ul>
	<ul id="thuNoi" style="list-style-type:none; padding-left: 0; padding-bottom: 0.5em; margin-bottom:1em; display: none"></ul>
	<!-- <div style="border-bottom: 1px; border-bottom-style: dashed; border-bottom-color: #999;"></div> -->
	</div>
	<div id="vuotQuaDeDuoi"> 
	<ol style="list-style-type:none; padding-left: 0;">
		<div class="vqdd">
			<p>Dễ duôi là một chướng ngại lớn nhất trên đường tu tập, cũng như trong sự rèn luyện, vươn lên trong cuộc sống của một con người bình thường. Dễ duôi là hành động theo bản năng, theo bất cứ đòi hỏi nào của tham sân si, của các trạng thái tâm bất thiện, một cách vô điều kiện mà không có ý định kháng cự.</p>
			<p>Thành công trong cuộc sống và trong tu tập phụ thuộc vào việc mình vượt qua dễ duôi như thế nào. Sau đây là một số cách để giúp chúng ta vượt qua dễ duôi:</p>
		</div>
		<li><i>Điều đầu tiên rất hiệu quả và dễ làm nhất là tránh xa các tác nhân kích hoạt sự dễ duôi, cũng là những điều cơ bản Đức Phật dạy: thu thúc giác quan, biết đủ với những thứ tối thiểu, ít nhu cầu, sống đơn giản, tránh xa những người dễ duôi và hay rủ rê</i>
			<p>Chẳng hạn muốn cai đồ ngọt thì đừng để nó trong tầm mắt, đừng xem món ăn có hại cho sức khỏe. Cai điện thoại thì tắt trong ngày nghỉ, hoặc để thật xa, mỗi lần lấy phải leo trèo hoặc phải mở khóa ngăn kéo, tắt wifi để dùng 3G cho chậm, hay là đổi điện thoại “cục gạch” (1 người học trò của thầy đã làm như thế thật đấy). Tâm chúng ta luôn thúc giục phải thỏa mãn ngay khi nó lên cơn, nhưng nghĩ đến việc phải mất thời gian đi lấy tự khắc nó sẽ ngại.</p>
			<p>Ít nhu cầu, ít đồ đạc, sống đơn giản sẽ làm tâm chúng ta thông thoáng hơn, nhìn mọi thứ rõ ràng hơn và mạnh mẽ hơn. Nhiều nhu cầu luôn lấy mất thời gian, không gian và năng lượng quý giá của chúng ta. Tránh xa những người mà ở gần thì những xu hướng dễ duôi và tiêu cực dễ nảy sinh và tăng lên, đây là một điều quan trọng mà Đức Phật đã nhiều lần nhấn mạnh. Xa tức là không để ý, không để họ chiếm hữu trong tâm và chi phối cách nghĩ của mình, và nếu không phải nhìn thấy hay nói chuyện là tốt nhất.
		</li>
		<li><i>Gần gũi bậc thiện trí, tiếp xúc thường xuyên với những thứ nhắc nhở mình tinh tấn</i>
			<p>Đức Phật nói: “Thấy pháp là thấy Như Lai”. Các con là cư sỹ tại gia, không có điều kiện tiếp xúc thường xuyên với các bậc tu hành chân chính đã giác ngộ, nhưng nếu luôn tinh tấn tu tập và có đức tin mạnh mẽ thì cũng coi như ở gần về mặt tinh thần. Nhất là thời bây giờ con có thể nghe pháp ở mọi nơi, mọi lúc, có thể đọc kinh điển, các lời sách tấn, dạy dỗ trên điện thoại. Hãy tận dụng điều đó.</p>
			<p>Giữ giới, thu thúc, tinh tấn… thì phải có đức tin mới làm được. Con hãy thể hiện đức tin đó bằng hành động cụ thể, nó sẽ làm con tăng trưởng đức tin hơn nữa. Sự nhắc nhở thường xuyên là rất quan trọng, đừng ỷ lại vào kiến thức và ảo tưởng về sức mạnh tinh tấn trong mình. Hãy đặt quanh mình, dán trên tường ở những chỗ mình hay nhìn, những hình ảnh nhắc nhở bản thân như: ảnh Phật, các câu nhắc chánh niệm, hay những câu quote gây động tâm, đặt ảnh màn hình chờ… Con có thể tải chương trình “Tiếng chuông chánh niệm” ở trang sutamphap.com về điện thoại để nó nhắc con mỗi 5 phút, 10 phút.</p>
			<p>Ngoài ra, hãy nghe pháp thường xuyên, đó là sự nhắc nhở và sách tấn rất lớn. Nghe 1 lần con không hiểu hết đâu, thực hành rồi nghe lại, lại thấy như mới, hiểu sâu hơn và động tâm ở những câu trước kia mình không cảm nhận được gì. Đấy chính là gần gũi bậc thiện trí con ạ.</p>
		</li>
		<li><i>Luyện thói quen trì hoãn, làm chậm mọi việc, dừng lại 1 phút trước khi quyết định làm gì, không bao giờ làm và quyết định khi cảm xúc đang ở đỉnh cao</i>
			<p>Sự thúc giục của cảm xúc luôn dâng trào bồng bột, nhưng chóng tàn. Chúng ta sẽ thấy sự thúc bách ấy như cưỡng ép, nhưng nếu trì hoãn 1 chút cho qua đỉnh cảm xúc, chúng ta sẽ có cơ hội chọn lựa có làm theo hay không, có cơ hội suy xét: đó là tham, sân, ngã mạn, ghen tỵ… muốn hay thực sự là mình muốn. Vì vậy, đừng đáp ứng ngay lập tức đòi hỏi của tâm, hãy tìm mọi cách trì hoãn, một phút tạm dừng đó sẽ cứu mình khỏi những bàn thua trông thấy.</p>
		</li>
		<li><i>Rèn luyện khả năng tự chế, bắt đầu từ những việc nhỏ nhất</i>
			<p>Người càng dễ duôi, khả năng tự chế càng kém. Khả năng tự chế trước mọi cám dỗ và thúc bách của tâm không phải tự nhiên mà có, mà là kết quả của sự rèn luyện thường xuyên, lâu dài. Hãy bắt đầu từ những việc nhỏ nhất, chẳng hạn: Tự chế ngự sự thúc giục muốn mở điện thoại xem tin nhắn mới đến – làm các bài test thử xem được bao nhiêu phút. Tự chế chỉ ăn 80% dạ dày; hoặc nhất định không gắp món ngon kia; bữa thắng, bữa thua, không sao cả.</p>
			<p>Thắng thua không quan trọng, điều quan trọng là mình đang tự rèn luyện. Tự chế không phạm giới bằng cách chủ động tham gia vào 1 câu chuyện với ý định rèn luyện không nói lời vô ích trong câu chuyện này. Để cái bánh ngọt trước mặt và nhìn nó, rèn luyện sự tự chế không ăn, đo xem chống cự được bao nhiêu phút để so với lần sau… (nhưng những cám dỗ quá lớn có khả năng phạm giới với hậu quả nặng thì đừng mang ra mà luyện. Tránh né là tốt nhất, yếu không nên ra gió).</p>
			<blockquote>Khả năng tự chế của chúng ta kém là vì chúng ta không bao giờ chủ động rèn luyện nó, mà chỉ khi gặp cám dỗ mới bị động mang đội quân chẳng bao giờ huấn luyện ra chống địch. Thua không oan.</blockquote>
		</li>
		<li><i>Có chế độ thưởng phạt và nghiêm túc làm theo. Kiểm điểm và ghi chép lại</i> 
			<p>Nhưng chớ có thưởng cho mình bằng cách được phép làm 1 cái gì có hại mà mình vẫn thường tự ngăn cấm bản thân. Phạt thì phạt theo cách tích cực, chẳng hạn lỡ ăn 1 miếng bánh thì phạt ngồi thiền 10 phút, hoặc tập thể dục 10 phút, đi bộ 1km...</p>
			<p>Nếu thấy mình nghị lực và tự giác kém thì nhờ người nhà làm trọng tài giám sát hộ. Ghi chép lại mỗi ngày thành bảng biểu để theo dõi mức độ tiến bộ, nhìn lại có thể thấy việc nào hay dễ duôi nhất, dựa trên thống kê để có chiến lược đối phó thích hợp.</p>
			<blockquote>Đừng bao giờ nghĩ rằng mình đã hiểu bản thân. Sự ghi chép thực tế và khách quan luôn cho chúng ta thấy rõ các mặt khuất và các điểm mù. Người tu tập thành công luôn là người rất nghiêm túc với bản thân, rất tự giác và nỗ lực.</blockquote>
		</li>
		<li><i>Thay thế ý định dễ duôi bằng việc làm ngay 1 việc tích cực. Tập thói quen năng động, sử dụng tối đa thời gian, không bao giờ ngồi không</i>
			<p>Nếu không chủ động làm việc tốt, tâm sẽ luôn có xu hướng làm việc xấu. Việc thay thế thường xuyên như thế sẽ làm cho cuộc sống của mình hướng về tích cực, làm được nhiều việc khó làm và thay đổi số phận.</p>
			<blockquote><Tại sao các bậc Thánh lại là Thánh nhân? Bởi vì các ngài nhẫn việc khó nhẫn, làm việc khó làm, và các ngài vẫn tiếp tục bước đi trong khi lòng luôn thúc giục bảo dừng.</blockquote>
		 	<p>Đức Phật dạy đừng thấy việc thiện nhỏ mà coi thường không làm, đừng thấy việc ác nhỏ mà làm theo. Thiện hay ác không tự nhiên mà có, do tích lũy dần mà thành. Cuộc đời chúng ta không tự nhiên mà sướng hay khổ, do tích lũy dần việc nhỏ mà nên.</p>
		</li>
		<li><i>Niệm chết, quán xét về vô thường và sự khổ. Thấy rõ sự nguy hiểm và các hậu quả của dễ duôi, ở bây giờ và trong tương lai</i>
			<p>Luôn nhắc nhở về cái chết để thấy sự trân quý và ý nghĩa của cuộc đời mỏng manh, nó khiến chúng ta động tâm thức tỉnh để tận dụng đầy đủ từng giây phút trong cuộc sống ngắn ngủi này. Đó là sự thật mà tâm dễ duôi thường sợ hãi và né tránh.</p>
			<p>Quán xét để nhìn thấu bản chất vô thường và khổ tiềm ẩn trong mọi thứ để bớt dính mắc với những thứ đang và sẽ mất đi; vui là ảo ảnh chóng tàn mà đau khổ là sự thật sờ sờ, khổ là kết quả tất yếu. Hãy hỏi mình:</p>
			<ul class="hilite">
				<li>Cuối cùng thì cũng để làm gì?</li>
				<li>Cũng chỉ là 1 cảm giác thoáng qua. Nhưng cái giá phải trả sẽ là gì?</li> 
				<li>Hậu quả tệ nhất có thể xảy đến là gì?</li>
				<li>Có đáng hay không?</li>
				<li>Bao nhiêu thứ mình đã từng theo đuổi trước đây có thực sự mang lại hạnh phúc như mình vẫn tưởng tượng trước và trong khi làm việc ấy hay không?</li> 
				<li>Và bao nhiêu đau khổ và mệt mỏi đã phải gánh chịu trong quá trình ấy?</li> 
				<li>Nếu hôm nay mình chết, thì việc này có thực sự là việc quan trọng mình vẫn muốn làm hay không?</li>
			</ul>
		</li>
		<li><i>Thường mường tượng đến mục đích và cuộc sống mình đang hướng đến trong tương lai một cách chân thực nhất, chi tiết nhất để tự nhắc nhở và tạo động lực cho bản thân</i>
			<p>Mục đích ấy càng thực tế và càng rõ ràng thì sẽ càng có tác dụng định hướng và tiếp thêm sức mạnh cho mình. Mỗi hành động, dự định của chúng ta trong hiện tại đều phải hướng đến mục đích ấy, cả cuộc sống đều là những bước chuẩn bị cho nó thành hiện thực, đều là những mảnh ghép đang được tích lũy lại chờ lúc ráp nối.</p>
			<p>Bất cứ hành động nào, dù là nhỏ nhất, có khả năng làm chệch hướng hoặc lãng phí nguồn lực (thời gian, năng lượng, sự chú ý, sự nhiệt tâm…) đều phải cắt bỏ.</p>
			<blockquote>Đừng sợ thất bại, đừng bàn lùi ở trong tâm và hãy tránh xa những kẻ hay bàn lùi. Thường xuyên kiểm điểm và kiên quyết cắt bỏ mọi nhánh rẽ, con đường lớn sẽ ngày càng hiện lên rõ ràng và thông thoáng hơn. Điều chỉ có trong mơ ấy sẽ lại gần hơn với chúng ta từng ngày.</blockquote>
		</li>
		<div class="vqdd">
		<p><b>You have to think anyway, so why not think big?</b></p>
		<p>Hãy thực hiện tổng hợp tất cả những điều trên. Dễ duôi mạnh hơn chúng ta nhiều lần, không có sức mạnh tổng hợp ấy thì khó mà chống lại được nó. Và ngay cả khi ấy, chúng ta vẫn cần phải có thêm một đồng minh quan trọng nữa là thời gian. Với người kiên nhẫn, thời gian là đồng minh, với người thiếu kiên nhẫn thời gian là kẻ thù.</p>
		<p>Hãy cố gắng lên con. Chúng ta đang xây tương lai từ những việc làm trong hiện tại. Xây lên lâu đài ước mơ hay cái lều vịt rách nát đều là do tay mình cả, chẳng phải do ông trời hay nghiệp chướng, định mệnh gì hết con ạ. Thầy thật muốn nhìn xem tòa lâu đài ấy của con ra sao trong 10 năm, trong 20 năm nữa – nếu thầy vẫn còn sống đến lúc ấy.</p>
		<p>Với tâm từ của thầy.</p>
		</div>
	</ol>
	</div>
</div>
</body>
<script>
var onVuotQuaDeDuoi = true;
function vuotQuaDeDuoi() {
	document.getElementById("thuyetPhapContainer").style = "display: none";
	document.getElementById("vuotQuaDeDuoi").style = "display: true";
  	if (onVuotQuaDeDuoi) {
		playPhap("phaps/vqdd.ogg?phaps/vqdd.mp3", "Vượt qua dễ duôi (Thầy dặn)");
		// document.getElementById("vuotQuaDeDuoiAudio").click();
		// var a = document.getElementById('audioPlayer');
		// a.addEventListener('timeupdate', function(){ if (a.currentTime >= 470) a.pause(); }, false); // 7.8 mins
	}
	onVuotQuaDeDuoi = true;
	onThuNoi = false;
	onNghePhap = false;
}

var onNghePhap = false;
function nghePhap() {
	var ul = document.getElementById("thuyetPhap"), items = ul.children, i=items.length+1;
	document.getElementById("thuyetPhapContainer").style = "display: true";
	document.getElementById("vuotQuaDeDuoi").style = "display: none";
	document.getElementById("thuyetPhap").style = "display: true";
	document.getElementById("thuNoi").style = "display: none";
	if (onNghePhap) {
		for (; i > 2; i--) {
			ul.appendChild(items[(Math.random()*(i-3)|0)+3]); 
		}
	}
	onNghePhap = true;
	onThuNoi = false;
	onVuotQuaDeDuoi = false;
}

var onThuNoi = false;
function ngheThuNoi() {
	var ul = document.getElementById("thuNoi"), items = ul.children, i=items.length+1;
	document.getElementById("thuyetPhapContainer").style = "display: true";
	document.getElementById("vuotQuaDeDuoi").style = "display: none";
	document.getElementById("thuyetPhap").style = "display: none";
	document.getElementById("thuNoi").style = "display: true";
	if (onThuNoi) {
		for (; i > 0; i--) { 
			ul.appendChild(items[(Math.random()*(i)|0)]); 
		}
	}
	onNghePhap = false;
	onThuNoi = true;
	onVuotQuaDeDuoi = false;
}

document.addEventListener("click", function (e) {		
	if (e.target.classList.contains("selectPhapToggle")) {
		var phapIndex = parseInt(e.target.getAttribute("phapIndex"));
		var index = document.selectedPhapIndexes.indexOf(phapIndex);
        console.log(phapIndex, index)
		if (index == -1) {
			document.selectedPhapIndexes.push(phapIndex);
			e.target.text = "[+]";
			e.target.style= "cursor:pointer; color:white";
		} else {
			document.selectedPhapIndexes.splice(index, 1);
			e.target.text = "[-]";
			e.target.style= "cursor:pointer; color:gray";
		}
		console.log(JSON.stringify(document.selectedPhapIndexes));
		if (document.useCookie) {
			document.cookie = document.selectedPhapIndexes.join(",") || "-1";
		}
		return;
	}
	var url = e.target.href;
	if (!url) { return; }
	if (e.target.download) { return; }
	event.preventDefault();
	playPhap(url, e.target.text);
});

function playPhap(url, title) {
	var sources = url.split('?'), p = document.getElementById('playing');
	var ap = document.getElementById("audioPlayer");
	var newap = (ap == null);
	if (!newap) {
		ap.pause();
		p.removeChild(p.lastChild);
	}
	p.innerHTML = '<p onclick="toggleFullscreen()" style="margin-top: 0.5em; margin-bottom: 0.5em;">[ '+title+' ]</p><audio ' + (newap ? '':'autoplay') + ' controls id="audioPlayer" style="width:100%; border-radius:0px;"><source src="'+sources[0]+'" /><source src="'+sources[1]+'" />Lỗi</audio>';

	ap = document.getElementById("audioPlayer");	
	ap.addEventListener('play', function(){ ap.autoplay = false; });
  	if (sources[0].includes("KinhHanhPhuc")) {
		var n = parseInt(sources[0].match(/(\d+?)\.ogg/)[1]);
		if (n < 10) { ap.addEventListener('ended', function(){ document.getElementById('KinhHanhPhuc' + (n+1)).click(); }); }
	}
	window.scrollTo(0,0); // scroll to top


	document.phapPlaying = false;
	document.timmings = [];
	document.timmingIndex = 0;
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function () {
		if (this.readyState == 4 && this.status == 200) {
			// console.log(this.responseText)
			document.timmings = JSON.parse(this.responseText).subtitles;
			document.timmings[0]['time'] = 0;
			document.nghepath = sources[0].replace(".ogg","").
				replace(location.host, "").replace(/http.+?\/\//,"");
			console.log("GOT SUBTITLES", document.nghepath);
			if (!location.hash.includes(document.nghepath)) { 
				document.timmingIndex = -1;
			} else { 
				initApp("playPhap");
			}
		}
	};
	xmlhttp.open("GET", sources[0].replace(".ogg",".json"), true);
	xmlhttp.send();
}

// Load phaps from json file and generate related HTML content
var xmlhttp = new XMLHttpRequest();
document.useCookie = (window.location.host == "localhost:3000");
xmlhttp.onreadystatechange = function () {
	if (this.readyState == 4 && this.status == 200) {
		let data = JSON.parse(this.responseText);
		document.phaps = data.phaps;
		if (document.useCookie)
		document.selectedPhapIndexes = (document.cookie || "-1").split(',').map(x => parseInt(x));
		var ul = document.getElementById("thuyetPhap");
		for (var i = data.phaps.length-2, elem; i >= 0; i--) {
			elem = document.createElement('li');
			str = ""
			if (document.selectedPhapIndexes) {
				selected = document.selectedPhapIndexes.includes(i);
				str = str+'<a class="selectPhapToggle" phapIndex="'+i+'" style="color:'+(!selected?'gray':'white')+'">['+(selected?'+':'-')+']</a>&nbsp;'
			}
			elem.innerHTML = str+'<a href="'+data.phaps[i].audio+'">'+data.phaps[i].title+'</a>';
			if (data.phaps[i]["id"]) { elem.lastElementChild.id = data.phaps[i].id; }
			ul.appendChild(elem);
		}
		// Render nois
		var ul = document.getElementById("thuNoi");
		for (var i = 0, elem; i <= data.nois.length-2; i++) {
			elem = document.createElement('li');
			elem.innerHTML = '<a href="'+data.nois[i].audio+'">'+data.nois[i].title+'</a>';
			if (data.nois[i]["id"]) { elem.lastElementChild.id = data.nois[i].id; }
			ul.appendChild(elem);
		}

		if (location.search == '?vqdd') { 
			playPhap("nois/Vuot-qua-de-duoi.ogg?https://sutamphap.com/wp-content/uploads/2021/03/Vuot-qua-de-duoi.mp3", "Vượt qua dễ duôi"); 
			return;
		}

		// document.getElementById("tutaptrongCS_NiemChet").click();
		var chosen = data.subtitled[Math.round(Math.random()*(data.subtitled.length-1))];

		document.phaps.forEach(function (phap) {
			if (phap.audio.includes(chosen)) {
				playPhap(phap.audio, phap.title);
				return;
			}
		});
	}
};
xmlhttp.open("GET", "/assets/audios.json", true);
xmlhttp.send();
</script>


<script src="/assets/quotes.js"></script>
<script>
var quoteIndex = Math.floor(Math.random() * document.quotes.length), count = 59;
var currTimeIndex = null, currText = null, currWordIndex = null, currWordTimmings = null, currWordTimeIndex = null, hiliteChanged = true;

window.setInterval(function () {
	var ap = document.getElementById("audioPlayer");
	if (document.timmingIndex == -1 && ap && !ap.paused) { 
		document.phapPlaying = true;
		currentTimeIndex = null;
		currWordIndex = 0;
	}

	// console.log(document.phapPlaying, document.timmingIndex);
	if (document.phapPlaying) {

		count = 3;
		document.getElementById('newQuote').innerText = "<< Trước";
		document.getElementById('option').value = "Sau >>";
		while (document.timmingIndex < document.timmings.length-1 
			&& ap.currentTime + 1 >= document.timmings[document.timmingIndex+1]['time']) { 
			document.timmingIndex++;
		}
		while (document.timmingIndex > 0
			&& ap.currentTime < document.timmings[document.timmingIndex]['time']) { 
			document.timmingIndex--;
		}

		var h1 = document.querySelector("h1");

		if (currTimeIndex != document.timmingIndex) {
			currTimeIndex = document.timmingIndex;

			console.log(currTimeIndex, document.timmings[currTimeIndex]);

			currText = document.timmings[currTimeIndex]["html"];
			if (!currText) {
				currText = document.timmings[currTimeIndex]['text'];
				currText = currText.replace(/(\d+)@(.*?)#/g, 
					`<span id="w$1" onclick="seekToWord($1)">$2</span>`);
				currText = currText.replace(/\\n/g, "<br/>").replace(/[\n|\\]/g, "<br/>");
				// cache for nextTime use
				document.timmings[currTimeIndex]["html"] = currText;
			}
			h1.innerHTML = currText;
			// console.log(currText);
			currWordTimmings = document.timmings[currTimeIndex]['timmings'];
			currWordTimeIndex = 0;
			hiliteChanged = true;
		}

		while (currWordTimeIndex < currWordTimmings.length-1 
			&& ap.currentTime > currWordTimmings[currWordTimeIndex][1]) { 
			currWordTimeIndex++;
			hiliteChanged = true;
		}		
		while (currWordTimeIndex > 0 && currWordTimmings[currWordTimeIndex][0] >= 0
			&& ap.currentTime < currWordTimmings[currWordTimeIndex][0]) { 
			currWordTimeIndex--;
			hiliteChanged = true;
		}
		if (hiliteChanged) {
			Array.from(h1.getElementsByClassName("hilite")).forEach(function(elem) {
				hiliteNum = parseInt(elem.className.match(/(\d+)$/)[1]) - 1;
				elem.className = hiliteNum > 0 ? `hilite hilite${hiliteNum}` : "";
			});
			var activeWord = document.getElementById("w"+currWordTimeIndex);
			activeWord.className = "hilite hilite3";
			if ((activeWord = activeWord.previousSibling) 
				&& (activeWord = activeWord.previousSibling)) 
				{ activeWord.className = "hilite hilite2"; }
			if (activeWord && (activeWord = activeWord.previousSibling) 
				&& (activeWord = activeWord.previousSibling)) 
				{ activeWord.className = "hilite hilite1"; }
			hiliteChanged = false;
		}
		if (location.hash != "#" + document.nghepath + "-" + document.timmingIndex) {
			document.autopopstate = true;
			location.hash = document.nghepath + "-" + document.timmingIndex;
		}

		if (ap.currentTime > ap.duration - 1) { 
			console.log(ap.currentTime, ap.duration)
			document.phapPlaying = false; 
		}

		document.getElementById("count").innerText = 
			Math.round(document.timmings[document.timmingIndex+1]['time'] - ap.currentTime);

	} else {

		document.getElementById('newQuote').innerText = "Lời dạy mới";
		if (!"Tắt tiếng|Đọc to".includes(document.getElementById('option').value)) { 
			document.getElementById('option').value = "Đọc to"; 
		}
		count = count - 0.2;
		document.getElementById("count").innerText = Math.ceil(count);
		if (count <= 0) newQuote();
	}
}, 200);

function seekToWord(wordIndex) {
	// console.log(wordIndex);
	var quote = document.getElementById("quote");
	Array.from(quote.getElementsByClassName("hilite")).forEach(elem => elem.className = "");
	var ap = document.getElementById("audioPlayer");
	ap.currentTime = currWordTimmings[wordIndex][0];
	// if (ap.paused) ap.play(); else ap.pause();
}


function newQuote(qIndex) {
	if (document.phapPlaying) {
		document.timmingIndex--;
		fixTimmingIndex();
		document.getElementById("audioPlayer").currentTime = 
			document.timmings[document.timmingIndex]['time'];
		return;
	}
	if (location.search != '?poem') {
		quoteIndex = qIndex ? qIndex : Math.floor(Math.random() * document.quotes.length);
	} else {
		quoteIndex = qIndex ? qIndex : quoteIndex + 1; 
		for (; quoteIndex < document.quotes.length; quoteIndex++)
			if (document.quotes[quoteIndex].match(":; ") || 
				document.quotes[quoteIndex].match(/;\s+([A-ZĐÁÀẢÃẠÂẤẦẨẪẬĂẮẰẲẴẶÉÈẺẼẸÊẾỀỂỄỆÍÌỈĨỊÓÒỎÕỌƠỚỜỞỠỢÔỐỒỔỖỘÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴ])/))
				break;
		if (quoteIndex == document.quotes.length) quoteIndex = 0;
	}
    quote = document.quotes[quoteIndex]
    	.replace(":; ", ":\n")
	    .replace(/([a-z”đáàảãạâấầẩẫậăắằẳẵặéèẻẽẹêếềểễệíìỉĩịóòỏõọơớờởỡợôốồổỗộúùủũụưứừửữựýỳỷỹỵ]);\s+([A-Z“ĐÁÀẢÃẠÂẤẦẨẪẬĂẮẰẲẴẶÉÈẺẼẸÊẾỀỂỄỆÍÌỈĨỊÓÒỎÕỌƠỚỜỞỠỢÔỐỒỔỖỘÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴ])/g, "$1,\n$2")
	    .replace(/;\s+([A-Z“ĐÁÀẢÃẠÂẤẦẨẪẬĂẮẰẲẴẶÉÈẺẼẸÊẾỀỂỄỆÍÌỈĨỊÓÒỎÕỌƠỚỜỞỠỢÔỐỒỔỖỘÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴ])/g, "\n$1")
    	;
    document.querySelector("h1").innerText = quote;
    if (document.getElementById("option").value != "Đọc to") { speakQuote(); }
    document.autopopstate = true;
    location.hash = "quote-" + quoteIndex;
    count = 59;
}

function speakQuoteToggle() {
	if (document.phapPlaying) {
		document.timmingIndex++;
		fixTimmingIndex();
		document.getElementById("audioPlayer").currentTime = 
			document.timmings[document.timmingIndex]['time'];
		return;
	}
	var o = document.getElementById("option");
	if (o.value == "Đọc to") { 
		o.value = "Tắt tiếng";
		if (audio.src) audio.play(); else speakQuote();
	} else { o.value = "Đọc to"; audio.pause(); }
}

var audio = document.createElement("audio"); audio.autoplay = true;
function speakQuote(i) {
	audio.src = "quotes/"+quoteIndex+".mp3";
	// audio.innerHTML = '<source src="quotes/'+(quoteIndex)+'.ogg" />' + '<source src="quotes/'+(quoteIndex)+'.mp3" />';
}

document.autopopstate = false;

function fixTimmingIndex() {
	if (document.timmingIndex < 0) { document.timmingIndex = 0; }
	if (document.timmingIndex > document.timmings.length) {
		document.timmingIndex = document.timmings.length-1;
	}
}

function initApp(from) {
	console.log(from, document.autopopstate);

	if (document.autopopstate) {
		document.autopopstate = false;
		return;
	}
	
	if (document.nghepath && location.hash.includes(document.nghepath)) {
		document.phapPlaying = true;
		document.timmingIndex = parseInt(location.hash.replace(/#.+?-/,""));
		fixTimmingIndex();
		console.log(from, document.timmingIndex);
		ap = document.getElementById("audioPlayer");
		if (ap) {
			ap.currentTime = document.timmings[document.timmingIndex]['time'];
			console.log("currentTime", ap.currentTime);
		}
	} else {
		newQuote(parseInt(location.hash.replace("#quote-","")));
	}
}

initApp('After quotes loaded');

window.onpopstate = function () { 
	// document.autopopstate = false; 
	initApp('onpopstate'); 
};

</script>


<script src="/assets/html2canvas.min.js"></script>
<script>
var downloadQuoteImageLink = document.createElement("a");
document.body.appendChild(downloadQuoteImageLink);
function luuAnh() {
	// document.exitFullscreen();
	var filename = location.hash.replace("#","")+".png";
	var quote = document.getElementById("quote");
	Array.from(quote.getElementsByClassName("hilite")).forEach(elem => elem.className = "");
	html2canvas(quote).then(function(canvas) {
        downloadQuoteImageLink.download = filename;
        downloadQuoteImageLink.href = canvas.toDataURL("image/png");
        downloadQuoteImageLink.target = '_blank';
        downloadQuoteImageLink.click();
    });
}

if (location.search == '?save') { luuAnh(); }

function toggleFullscreen() {

    if (!document.fullscreenElement) {
    	document.documentElement.requestFullscreen();
    } else {
    	document.exitFullscreen();
	}
}

const copyToClipboard = str => {
  const el = document.createElement('textarea');
  el.value = str;
  document.body.appendChild(el);
  el.select();
  document.execCommand('copy');
  document.body.removeChild(el);
};

document.addEventListener("keyup", function(event) {
	console.log(event.keyCode);
    if (event.keyCode === 37) {
    	// arrow left
    	newQuote();

    } else if (event.keyCode === 39) {
    	// arrow right
    	speakQuoteToggle();
    } else if (event.keyCode === 16) {
    	// shift
    	var ap = document.getElementById("audioPlayer");
    	if (ap.paused) ap.play(); else ap.pause();
    	copyToClipboard(document.querySelector("h1").innerText);
	} else if (event.keyCode === 13) {
		copyToClipboard(document.querySelector("h1").innerText);
	}
});

// https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/hash-map-of.html
function selectedPhaps() {
	document.ktHash = document.selectedPhapIndexes.map(function (x) {
		phap = document.phaps[x];
		phapId = phap.audio.split("?https")[0];
		return `"${phapId}" to "${phap.title}"`;
	}).join(",\n");
	console.log(document.ktHash);
}
</script>
</html>
