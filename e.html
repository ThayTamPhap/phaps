<!DOCTYPE html>
<html lang="vi-VN">
<head>
<meta charset="utf-8">
<style type="text/css">
  #audioPlayer { position: fixed; margin-top: -10px; }
  
  div { margin-top: 0.5em; font-size: 14pt; padding: .3em; color: #ccc; }
  
  p { padding-top: 0.5em; padding-bottom: 0.5em; margin: 0.1em; 
      border-style: dotted; border-width: 1px; }
  
  p.edited { color: #666; }
  
  p:focus { color: #000; border: 0px; border-style: none; color: #112699; }
  
  i { font-size: 12pt; color: #aaa; }
</style>
 </head>
<body>
  <audio controls id="audioPlayer" style="width:100%;">
  </audio>
  <a></a>
  <br />
</body>

<script>
var phapname = location.search.replace("?", "")
console.log('phapname', phapname);

var ap = document.getElementById("audioPlayer");
ap.innerHTML = `<source src="${phapname}.ogg" /><source src="${phapname}.mp3" />`

var subsCount, currSubIndex, currKey;


if (phapname == load('phapname')) {
    console.log("Found cached data");
    genSubs();

} else {
  save('phapname', phapname);

  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200) {
      txt = this.responseText;
      initSubs(txt);
      genSubs();
    }
  };
  xmlhttp.open("GET", phapname+".lab", true);
  xmlhttp.send();
}


function saveSubsCount(value) {
  subsCount = value;
  save('subsCount', subsCount);
}
function loadSubsCount() {
  return subsCount = parseInt(load('subsCount'));
}

function load(key) {
  return window.sessionStorage.getItem(key);
}
function save(key, value) {
  window.sessionStorage.setItem(key, value);
}
function markEditedIndex(i) {
  save(`edited${i}`, true);
}
function isEditedIndex(i) {
  return load(`edited${i}`) === 'true';
}
function saveTime(i, value) {
  save(`time${i}`, value);
  markEditedIndex(i);
  var el = document.getElementById(i);
  if (el) {
    el.previousSibling.innerHTML = value;
    el.className = 'edited';
  }
}
function loadTime(i) {
  return parseFloat(load(`time${i}`));
}
function loadMaxTime(i) {
  return parseFloat(load(`maxtime${i}`));
}

function saveTextIndex(i) {
  saveText(i, document.getElementById(i).innerHTML.replace(/<i.+i>/,''));
}
function saveText(i, value) {
  save(`text${i}`, value);
  save(`maxtime${i}`, loadTime(i)+estimateDuration(value, 1.8));
}
function loadText(i) {
  return load(`text${i}`);
}
function estimateDuration(txt, speed) {
  return txt.split(/\s+/).length / (speed || 2.0);
}
function saveAll() {
  for (var i = 0; i < subsCount; i++) {
    saveTextIndex(i);
  }
}
function result() {
  var str = "";
  for (var i = 0; i < subsCount; i++) {
    str = str + `${loadTime(i)} ${loadText(i)}\n`;
  }
  var a = document.querySelector("a");
  var file = new Blob([str], {type: 'text/plain'});
  a.href = URL.createObjectURL(file);
  a.download = phapname.split("/")[1] + '.lrc';
  a.click();
  // console.log(str);
}


function initSubs(txt) {
  var sents = [];
  var splits = txt.split(/(\s*(?:\n|\.)\s*)+/);
  var n = splits.length/2, i = 0;
  for (; i < n; i = i + 2) {
    sents.push(splits[i] + splits[i+1].replace(/\n/g,'\\'))
  }
  if (i < splits.length - 1) {
    sents.push(splits[i+1]);
  }
  saveSubsCount(sents.length);
  var time = 0.0;
  for (n = sents.length, i = 0; i < n; i++) {
    if (i > 0) { time = time + estimateDuration(sents[i-1]); }
    saveTime(i, time);
    saveText(i, sents[i]);
  }
}

function genSubs() {
  loadSubsCount();
  for (var p, div, time, text, i = 0; i < subsCount; i++) {
    div = document.createElement('div');
    div.innerHTML = `<i>${loadTime(i)}</i>`;
    div.onclick = function() { console.log(this.children[1].focus()); };
    p = document.createElement('p');
    p.contentEditable = "true";
    p.innerHTML = loadText(i);
    p.id = i;
    p.className = isEditedIndex(i) ? 'edited' : '';
    p.addEventListener("click", playSub);
    p.addEventListener("focus", updateSub);
    div.appendChild(p);
    document.body.appendChild(div);
  }
  currSubIndex = parseInt(load('currSubIndex'));
  if (!isNaN(currSubIndex) && currSubIndex != null) {
    console.log('currSubIndex', currSubIndex);
    document.getElementById(currSubIndex).focus();
  }
}


/* - - - - */ 

ap.ontimeupdate = function() {
  var maxTime = loadMaxTime(currSubIndex);
  var currTime = ap.currentTime;
  if (maxTime - currTime < 8) maxTime = currTime + 8;
  if (ap.currentTime >= maxTime) ap.pause();
};

function playSub(event) {
  var index = parseInt(this.id);
  if (currSubIndex != index) {
    currSubIndex = index;
    var time = parseFloat(loadTime(currSubIndex));
    ap.currentTime = time;
    console.log('currSubIndex', currSubIndex, ', time', time, 'maxTime', loadMaxTime(currSubIndex));
  } else {
  }
}

function updateSub() {
  save('currSubIndex', currSubIndex);
  if /* tab, ctrl */ (currKey === 9 || currKey === 17) {
    var time = ap.currentTime;
    console.log('currSubIndex', currSubIndex, 'currentTime', time);
    saveTime(currSubIndex, time);
    if (currKey ===  9) saveTextIndex(currSubIndex - 1);
    else saveTextIndex(currSubIndex);
    currKey = null;
  }
}

function seekCurrTime(delta) {
  var time = loadTime(currSubIndex) + delta;
  saveTime(currSubIndex, time);
  ap.currentTime = time;
  ap.play();
}

document.addEventListener("keydown", function(event) {
  currKey = event.keyCode;
  console.log('currKey', currKey);
  if        /* ctrl  */ (currKey === 17) {

      ap.currentTime = loadTime(currSubIndex);
      ap.play();

  } else if /* esc   */ (currKey === 27) {

      seekCurrTime(0.3);

  } else if /* `/~   */ (currKey === 192) {

      event.preventDefault();
      seekCurrTime(-0.3);

  } else if /* alt   */ (currKey === 18) {

      if (ap.paused) ap.play(); else {
        ap.currentTime = ap.currentTime - 3;
        ap.pause();
      }

  } else if /* tab   */ (currKey ===  9) {

      event.preventDefault();
      nextSub();

  } else if /*command*/ (currKey === 224) {
    

  } else if /* a-z   */ (currKey >= 65 && currKey <= 90) {

      ap.pause();
  }
});

function nextSub() {
  if (currSubIndex < subsCount - 1) { 
    currSubIndex++;  
    document.getElementById(currSubIndex).focus();
  }
}
</script>
</html>
