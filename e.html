<!DOCTYPE html>
<html lang="vi-VN">
<head>
<meta charset="utf-8">
<style type="text/css">
  #audioPlayer { position: fixed; margin-top: -10px; }
  p { margin-top: 1em; font-size: 14pt; padding: .5em; border-style: dotted; border-width: 1px; }
  i { display: block; color: #aaa; }  
</style>
 </head>
<body>
  <audio autoplay controls id="audioPlayer" style="width:100%;">
    <source src="phaps/vqdd.mp3" />Lá»—i</audio>
  <br />
</body>

<script>
var ap = document.getElementById("audioPlayer");
var subsCount, currSubIndex, currKey;

function resetsubsCount() {
  save('subsCount', '');
}
function saveSubsCount(value) {
  subsCount = value;
  save('subsCount', subsCount);
}
function loadSubsCount() {
  return subsCount = parseInt(load('subsCount'));
}

function load(key) {
  return window.sessionStorage.getItem(key);
}
function save(key, value) {
  window.sessionStorage.setItem(key, value);
}

function saveTime(i, value) {
  save(`time${i}`, value);
  var el = document.getElementById(i);
  if (el) el.children[0].innerHTML = value;
}
function loadTime(i) {
  return parseFloat(load(`time${i}`));
}
function loadMaxTime(i) {
  return parseFloat(load(`maxtime${i}`));
}

function saveTextIndex(i) {
  saveText(i, document.getElementById(i).innerHTML.replace(/<i.+i>/,''));
}
function saveText(i, value) {
  save(`text${i}`, value);
  save(`maxtime${i}`, loadTime(i)+estimateDuration(value, 1.8));
}
function loadText(i) {
  return load(`text${i}`);
}
function estimateDuration(txt, speed) {
  return txt.split(/\s+/).length / (speed || 2.0);
}
function saveAll() {
  for (var i = 0; i < subsCount; i++) {
    saveTextIndex(i);
  }
}
function export() {
  var str = "";
  for (var i = 0; i < subsCount; i++) {
    str = str + `${loadTime(i)} ${loadText(i)}\n`;
  }
  console.log(str);
}

if (loadSubsCount()) {
    genSubs();

} else {

  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200) {
      txt = this.responseText;
      initSubs(txt);
      genSubs();
    }
  };
  xmlhttp.open("GET", "phaps/vqdd.lab", true);
  xmlhttp.send();
}

function initSubs(txt) {
  var sents = txt.split(/(?:\s*(?:\n|\.)\s*)+/);
  saveSubsCount(sents.length);
  var time = 0.0;
  for (var i = 0; i < sents.length; i++) {
    if (i > 0) { time = time + estimateDuration(sents[i-1]); }
    saveTime(i, time);
    saveText(i, sents[i]);
  }
}

function genSubs() {
  for (var el, time, text, i = 0; i < subsCount; i++) {
    el = document.createElement('p');
    el.contentEditable = "true";
    el.innerHTML = `<i>${loadTime(i)}</i>${loadText(i)}`;
    el.id = i;
    el.addEventListener("click", playSub);
    el.addEventListener("focus", updateSub);
    document.body.appendChild(el);
  }
  currSubIndex = parseInt(load('currSubIndex'));
  if (!isNaN(currSubIndex) && currSubIndex != null) {
    console.log('currSubIndex', currSubIndex);
    document.getElementById(currSubIndex).focus();
  }
}


/* - - - - */ 

ap.ontimeupdate = function() {
  var maxTime = loadMaxTime(currSubIndex);
  var currTime = ap.currentTime;
  if (maxTime - currTime < 8) maxTime = currTime + 8;
  if (ap.currentTime >= maxTime) ap.pause();
};

function playSub(event) {
  var index = parseInt(this.id);
  if (currSubIndex != index) {
    currSubIndex = index;
    var time = parseFloat(loadTime(currSubIndex));
    ap.currentTime = time;
    console.log('currSubIndex', currSubIndex, ', time', time, 'maxTime', loadMaxTime(currSubIndex));
  } else {
  }
}

function updateSub() {
  save('currSubIndex', currSubIndex);
  if /* tab, ctrl */ (currKey === 9 || currKey === 17) {
    var time = ap.currentTime;
    console.log('currSubIndex', currSubIndex, 'currentTime', time);
    saveTime(currSubIndex, time);
    if (currKey ===  9) saveTextIndex(currSubIndex - 1);
    else saveTextIndex(currSubIndex);
    currKey = null;
  }
}

function seekCurrTime(delta) {
  var time = loadTime(currSubIndex) + delta;
  saveTime(currSubIndex, time);
  ap.currentTime = time;
  ap.play();
}

document.addEventListener("keydown", function(event) {
  currKey = event.keyCode;
  console.log('currKey', currKey);
  if        /* ctrl  */ (currKey === 17) {

      ap.currentTime = loadTime(currSubIndex);
      ap.play();

  } else if /* esc   */ (currKey === 27) {

      seekCurrTime(0.3);

  } else if /* `/~   */ (currKey === 192) {

      event.preventDefault();
      seekCurrTime(-0.3);

  } else if /* alt   */ (currKey === 18) {

      if (ap.paused) ap.play(); else {
        ap.currentTime = ap.currentTime - 3;
        ap.pause();
      }

  } else if /* tab   */ (currKey ===  9) {

      event.preventDefault();
      nextSub();

  } else if /*command*/ (currKey === 224) {
    

  } else if /* a-z   */ (currKey >= 65 && currKey <= 90) {

      ap.pause();
  }
});

function nextSub() {
  if (currSubIndex < subsCount - 1) { 
    currSubIndex++;  
    document.getElementById(currSubIndex).focus();
  }
}
</script>
</html>
